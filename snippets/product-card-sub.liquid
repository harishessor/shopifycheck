{%- comment -%}
----------------------------------------------------------------------------------------------------------------------
PRODUCT CARD COMPONENT
----------------------------------------------------------------------------------------------------------------------

This component is used in collection and featured collection to render a single product as a card

********************************************
Supported variables
********************************************

* product: the product to render
* stacked: define if the product is stacked or not on mobile
* reveal: if set to true, the card will be revealed on scroll through animation
* position: the position of the card in the list. If specified, the theme will eagerly load the first 3 cards images
* show_badges: show or not the badges (default to true if nothing is set).
* show_rating: show or not the rating. If nothing is set, the theme uses the default product card setting
* show_vendor: show or not the vendor. If nothing is set, the theme uses the default product card setting
* show_quick_buy: show or not the quick buy (which open a modal if the product contains more than 1 choice)
* show_secondary_image: show or not the secondary media on hover. If nothing is set, the theme uses the default product card setting
* show_swatches: show or not the swatches. The swatch type is inferred from setting, and will default to true if nothing is set.
* hide_product_information: if set to true, all content (vendor, badge, title...) are not rendered, to create image-based grid
* quick_buy_context: a unique text to dissociate quick buy if the same product is embedded multiple times
{%- endcomment -%}

{%- liquid
  if hide_product_information
    assign show_badges = false
    assign show_rating = false
    assign show_vendor = false
    assign show_title = false
    assign show_prices = false
    assign show_swatches = false
    assign show_quick_buy = show_quick_buy | default: settings.show_quick_buy, allow_false: true
    assign show_secondary_image = show_secondary_image | default: settings.show_secondary_image, allow_false: true
  else
    assign show_badges = show_badges | default: true, allow_false: true
    assign show_rating = show_rating | default: settings.show_product_rating, allow_false: true
    assign show_vendor = show_vendor | default: settings.show_vendor, allow_false: true
    assign show_quick_buy = show_quick_buy | default: settings.show_quick_buy, allow_false: true
    assign show_title = true
    assign show_prices = true
    assign show_secondary_image = show_secondary_image | default: settings.show_secondary_image, allow_false: true
    assign show_swatches = show_swatches | default: true, allow_false: true
  endif
-%}
{%- assign color_white_label = 'general.label.white' | t | downcase -%}

{%- assign scent_option_index = nil -%}
{%- assign size_option_index = nil -%}

{%- for option in product.options_with_values -%}
  {%- assign option_name_downcase = option.name | downcase -%}
  {%- if option_name_downcase contains 'scent' or option_name_downcase contains 'fragrance' -%}
    {%- assign scent_option_index = forloop.index0 -%}
  {%- elsif option_name_downcase contains 'size' or option_name_downcase contains 'volume' -%}
    {%- assign size_option_index = forloop.index0 -%}
  {%- endif -%}
{%- endfor -%}
{%- if scent_option_index == nil or size_option_index == nil -%}
  {%- comment -%}
  Handle the case where the indices are not found, possibly by setting default values or logging an error.
  {%- endcomment -%}
  {%- assign scent_option_index = 0 -%}
  {%- assign size_option_index = 1 -%}
{%- endif -%}


{%- liquid
  assign size_option_index_plus_1 = size_option_index |  plus: 1
  assign sort_field = 'option' | append: size_option_index_plus_1
  assign sorted_variants = product.variants |  where: 'available', true | sort: sort_field
  assign current_size = ''
  assign data = ''
  assign size_separator = ','
  assign group_separator = '/'
  assign part_separator = ':'
  assign valid_scents = '' | split: ','

  for variant in sorted_variants
    unless variant.selling_plan_allocations.size > 0
      continue
    endunless

    assign valid_scents = valid_scents | append: variant.options[scent_option_index]
    assign size = variant.options[size_option_index]

    if current_size == ''
      assign current_size = size
      assign data = size | append: part_separator | append: variant.id
    elsif size == current_size
      assign data = data | append: size_separator | append: variant.id
    else
      assign data = data | append: group_separator | append: size | append: part_separator | append: variant.id
      assign current_size = size
    endif
  endfor
-%}
{% for variant in sorted_variants %}
    {% unless variant.available %}
    {% continue %}
    {% endunless %}
    {% unless variant.selling_plan_allocations.size > 0 %}
      {% continue  %}
    {% endunless %}

    {% if variant.options[size_option_index] == "Refill" or variant.options[size_option_index] == "Refill (Pack of 2)" %}
    {%- liquid
      assign groups = data | split: group_separator
      assign is_first_variant_in_group = false
      assign group_variant_ids = '' | split: ','

      if groups.size > 0
        for group in groups
          assign parts = group | split: part_separator
          if parts.size > 1
            assign group_size = parts[0]
            assign group_variant_ids = parts[1] | split: ','
            assign variant_size = variant.options[size_option_index]
            if group_size == variant_size
              comment
              echo 'group_size: ' | append: group_size | append: ' variant_size: ' | append: variant_size | append: '<br>'
              echo 'group_variant_ids: ' | append: group_variant_ids | append: '<br>'
              echo 'variant_id: ' | append: variant.id | append: '<br>'
              endcomment
              assign variant_id_str = variant.id | append: ''
              for vid in group_variant_ids
                if vid == variant_id_str and forloop.first
                  assign is_first_variant_in_group = true
                endif
              endfor
              break
            endif
          endif
        endfor
      endif
    -%}

      {% comment %} variant: {{ variant | json }} {% endcomment %}
    {%-liquid
      assign variant_compare_at_price = variant.compare_at_price
      assign variant_price = variant.price
      if variant.product.selling_plan_groups.size
        comment
        endcomment
        assign variant_compare_at_price = variant.selling_plan_allocations[0].compare_at_price
        assign variant_price = variant.selling_plan_allocations[0].price
      endif
    -%}


    {%- if variant.url contains '?' -%}
      {%- assign product_url_contains_query = true -%}
    {%- else -%}
      {%- assign product_url_contains_query = false -%}
    {%- endif -%}

    <product-card class="product-card{% if is_first_variant_in_group == false  %} hidden {% endif %}" {% if reveal %}reveal-on-scroll="true"{% endif %} handle="{{ product.handle | escape }}" 
    data-product-id="{{ variant.product.id }}"
    data-variant-id="{{ variant.id }}"
    data-size="{{ variant.options[size_option_index] }}">
      <div class="product-card__wrapper">
        {%- if product.media.size > 0 -%}
          <div class="product-card__figure">
            {%- if show_badges -%}
              {%- render 'product-badges', product: product, vertical: true, context: 'card' -%}
            {%- endif -%}
    
            <a href="{{ variant.url }}" class="product-card__media" draggable="false" data-instant>
              {%- capture sizes -%}
                {%- if stacked -%}
                  (max-width: 699px) calc(100vw / {{ section.settings.products_per_row_mobile }}), (max-width: 999px) calc(100vw / {{ 3 | at_most: section.settings.products_per_row_desktop | default: 3 }} - 64px), calc((100vw - 96px) / {{ section.settings.products_per_row_desktop | default: 3 }} - (24px / {{ section.settings.products_per_row_desktop | default: 3 }} * {{ section.settings.products_per_row_desktop | default: 3 | minus: 1 }}))
                {%- else -%}
                  (max-width: 699px) 74vw, (max-width: 999px) 38vw, calc((100vw - 96px) / {{ section.settings.products_per_row_desktop | default: 3 }} - (24px / {{ section.settings.products_per_row_desktop | default: 3 }} * {{ section.settings.products_per_row_desktop | default: 3 | minus: 1 }}))
                {%- endif -%}
              {%- endcapture -%}
    
              {%- liquid
                assign main_media_loading_strategy = nil
                if section.index > 3 or position > 3
                  assign main_media_loading_strategy = 'lazy'
                endif
              -%}
    
              {%- capture main_image_classes -%}
                product-card__image product-card__image--primary 
                {% if settings.product_image_aspect_ratio contains 'crop' %}object-cover{% endif %} 
                aspect-{{ settings.product_image_aspect_ratio | split: '_' | first }}
              {%- endcapture -%}
              {{- variant.featured_media | image_url: width: variant.featured_media.width | image_tag: loading: main_media_loading_strategy, sizes: sizes, widths: '200,300,400,500,600,700,800,1000,1200,1400,1600,1800', draggable: 'false', class: main_image_classes -}}
    
              {%- liquid
                if show_secondary_image and variant.media.size > 1
                  assign next_media =  variant.media[1]
                  if next_media != blank
                    echo next_media | image_url: width: next_media.width | image_tag: class: 'product-card__image product-card__image--secondary', loading: 'lazy', fetchpriority: 'low', sizes: sizes, widths: '200,300,400,500,600,700,800,1000,1200,1400,1600,1800', draggable: 'false'
                  endif
                endif
              -%}
            </a>
          </div>
        {%- endif -%}
    
        <div class="product-card__info empty:hidden">
          {%- assign text_class = '' -%}
          {%- if settings.product_card_text_font == 'heading' -%}
            {%- assign text_class = 'h6' -%}
          {%- endif -%}
    
          {%- if show_title or show_prices or show_vendor and product.vendor != blank -%}
            <div class="v-stack justify-items-center gap-2">
              {%- if show_vendor and product.vendor != blank -%}
                {%- capture vendor_class -%}smallcaps {% if settings.product_card_text_font == 'heading' %}heading{% endif %}{% endcapture %}
                {%- render 'vendor' with product.vendor, class: vendor_class -%}
              {%- endif -%}
    
              {%- if show_title or show_prices -%}
                <div class="v-stack justify-items-center gap-1">
                  {%- if show_title -%}
                    <a href="{{ variant.url }}" class="product-title {% if text_class != blank %}{{ text_class }}{% endif %} {% if settings.product_title_max_lines > 0 %}line-clamp{% endif %}" {% if settings.product_title_max_lines > 0 %}style="--line-clamp-count: {{ settings.product_title_max_lines }}"{% endif %} data-instant>
                      <b>{{- variant.product.title | split: '(' | first | strip -}}</b><br>
                      {% for option in variant.options %}
                        {{ option }}{% unless forloop.last == true %}<br>{%- endunless -%}
                      {% endfor %}
                    </a>
                  {%- comment -%}
                Show the matched variant name (only when fake-tag filtering is on and a variant matched)
              {%- endcomment -%}
              {%- if matched_variant_title and matched_variant_title != '' -%}
                <div class="product-card__variant-name text-subdued text-xs">
                  {{ matched_variant_title }}
                </div>
              {%- endif -%}
    
                  {%- endif -%}
    
                  {%- if show_prices -%}
                    {% comment %} {%- render 'price-list', product: product, context: 'card' -%} {% endcomment %}
                    {%- liquid
                      assign subscription_discount_percent = 15
                      assign subscription_discount_multiplier = 100 | minus: subscription_discount_percent
                      assign subscription_discount_amount = variant_price | times: subscription_discount_multiplier | divided_by: 100
                    -%}

                    <price-list class="price-list price-list--product">
                      <sale-price class="h6 text-on-sale">
                        {%- if settings.currency_code_enabled -%}
                              {{- variant_price | money_with_currency -}}
                            {%- else -%}
                              {{- variant_price | money -}}
                          {%- endif -%}
                         
                        {% comment %} <span class="sr-only">Sale price</span>$25.49 {% endcomment %}
                        </sale-price>
                        <compare-at-price class="h6 text-subdued line-through">
                          {%- if settings.currency_code_enabled -%}
                            {{- variant_compare_at_price | money_with_currency -}}
                          {%- else -%}
                            {{- variant_compare_at_price | money -}}
                          {%- endif -%}
                        </compare-at-price>
                    </price-list>

                  
                  {%- endif -%}
                </div>
              {%- endif -%}
            </div>
          {%- endif -%}
    
          {%- if show_swatches and settings.product_color_display != 'hide' -%}
            {%- liquid
              assign matched_product_option = nil
              assign color_label_list = 'general.label.color' | t | replace: ', ', ',' | downcase | split: ','
              for color_label in color_label_list
                if product.options_by_name[color_label] != blank
                  assign matched_product_option = product.options_by_name[color_label]
                  break
                endif
              endfor
              if matched_product_option == blank
                for product_option in product.options_with_values
                  assign values_with_swatch = product_option.values | where: 'swatch'
                  if values_with_swatch.size > 0
                    assign matched_product_option = product_option
                    break
                  endif
                endfor
              endif
            -%}
            {%- if matched_product_option != blank -%}
              {%- case settings.product_color_display -%}
                {%- when 'count' -%}
                  <p class="smallcaps text-subdued">
                    {{- 'product.general.available_colors_count' | t: count: matched_product_option.values.size -}}
                  </p>
                {%- when 'swatch' -%}
                  <fieldset class="h-stack wrap justify-center gap-1">
                    <legend class="sr-only">{{ matched_product_option.name }}</legend>
                    {%- capture param_name -%}swatch-{{ quick_buy_context }}-{{ section.id }}-{{ product.id }}-{{ matched_product_option.position }}{%- endcapture -%}
                    {%- liquid
                      for option_value in matched_product_option.values
                        render 'option-value', type: 'swatch', option_value: option_value, param_name: param_name, option_position: matched_product_option.position, output_variant_media: true, size: 'sm'
                      endfor
                    -%}
                  </fieldset>
              {%- endcase -%}
            {%- endif -%}
          {%- endif -%}
    
          {%- if show_rating -%}
            {%- render 'product-rating', product: product, show_empty: settings.show_product_rating_if_empty, display_mode: settings.product_rating_mode -%}
          {%- endif -%}
        </div>
    
        {%- if show_quick_buy and product.available -%}
          <div class="product-card__actions {% unless product.selling_plan_groups.size > 0 %}no-subscription{% endunless %}">
            {%- if product.variants.size == 1 and product.selling_plan_groups.size == 0 -%}
            {% comment %} {%- if product.selling_plan_groups.size == 0 -%} {% endcomment %}
              <product-form>
                {%- form 'product', product -%}
                  <input type="hidden" name="on_success" value="force_open_drawer">
                  <input type="hidden" name="quantity" value="1">
                  <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">
                  <button type="submit" class="product-card__quick-add-button">
                    <span class="sr-only">{{ 'product.general.add_to_cart_button' | t }}</span>
                    ADD TO CART
                  </button>
                {%- endform -%}
              </product-form>
            {%- else -%}
              
              {% comment %} {%- assign current_variant = product.selected_or_first_available_variant -%} {% endcomment %}
              {%- assign current_variant = variant -%}
              {%- assign product_form_id = 'product-form-' | append: variant.id | append: section.id -%}
              
              <product-form class="w-full">
                {%- form 'product', product, id: product_form_id, class: 'v-stack gap-3' -%}
                  
                  <input type="hidden" name="id" value="{{ current_variant.id }}">
                  <input type="hidden" name="quantity" value="1">
                  
                  {%- comment -%} 1. Swatch Selector (Color/Scent variants) {%- endcomment -%}
                  {%- liquid
                    assign swatch_option_index = 0
                    assign option = product.options_with_values[swatch_option_index]
                    assign default_swatch_value = current_variant.options[swatch_option_index]
                    assign color_swatch_config = settings.color_swatch_config | newline_to_br | split: '<br />'
                    assign locked_option_index = 1
                    assign locked_option_value = "Refill"
                    assign locked_option_value2 = "Refill (Pack of 2)"
                    
                    -%}
                    {% comment %} assign locked_option_value = product.options_with_values[locked_option_index].values | first {% endcomment %}
    
                  {%- if option != blank and option.values.size > 0 -%}
                    {% comment %} <div class="color-swatch-list justify-center h-stack gap-1">
                      {% comment %} <fieldset class="h-stack wrap justify-center gap-1"> {% endcomment %}
                        {% comment %} <legend class="sr-only">{{ option.name }}</legend> {% endcomment %}
                        
                        {%- for value in option.values -%}
                          
                           {%- assign is_selected = false -%}
                            {%- if value == default_swatch_value -%}
                              {%- assign is_selected = true -%}
                            {%- endif -%}
    
                            {%- assign is_swatch_available = false -%}
                          {%- for variant in product.variants -%}                              
                                {%- assign matches_swatch = false -%}
                                {%- assign matches_locked = false -%}
                                {%- if variant.options[swatch_option_index] == value -%}
                                    {%- assign matches_swatch = true -%}
                                {%- endif -%}
                                {%- if matches_swatch or variant.options[locked_option_index] == locked_option_value  -%}
                                  {%- assign matches_locked = true -%}
                                {%- endif -%}
                                {%- if matches_locked or variant.options[locked_option_index] == locked_option_value2  -%}
                                    {%- assign matches_locked = true -%}
                                {%- endif -%}
                                {%- if matches_swatch and matches_locked and variant.available -%}
                                    {%- if variant.selling_plan_allocations.size > 0 -%}
                                      {%- assign is_swatch_available = true -%}
                                      {%- break -%}
                                    {%- endif -%}
                                {%- endif -%}
                              {%- endfor -%}
                              
                            
                            {%- assign is_swatch_disabled = false -%}
                            {%- unless is_swatch_available -%}
                                {%- assign is_swatch_disabled = true -%}
                            {%- endunless -%}

                            

                          <div class="color-swatch{% if color_white_label == color_value_downcase %}color-swatch--white{% endif %} {% if option.values.size ==1 %}hidden{% endif %}">
                            <input
                              class="color-swatch__radio"
                              type="radio"
                              name="option{{ option.position }}"
                              form="{{ product_form_id }}"
                              id="card_swatch_{{ variant.id }}_{{ forloop.index }}"
                              value="{{ value | escape }}"
                              {% if is_selected %}
                                checked="checked"
                              {% endif %}
                              {% if is_swatch_disabled %}
                                 disabled="disabled" 
                               {% endif %}
                            >
                            <label
                              class="color-swatch__item {% if is_selected %}selected{% endif %}"
                              for="card_swatch_{{ variant.id }}_{{ forloop.index }}"
                              title="{{ value | escape }}"
                              style="{%- render 'color-swatch-style', color_swatch_config: color_swatch_config, value: value -%}" 
                              {% comment %} onclick="handleVariantSelect({{ variant.product.id }}, {{ variant.id }}, '{{ variant.options[size_option_index] }}')" {% endcomment %}
                            >
                              {% comment %} <span class="visually-hidden">{{ value }}</span>  {% endcomment %}
                            </label>
                          </div>
                        {%- endfor -%}
                      {% comment %} </fieldset> {% endcomment %}
                    </div> {% endcomment %}


                    <div class="color-swatch-list justify-center h-stack gap-1">
                      {%- comment -%} Determine the size of the product card being rendered by the outer loop -{% endcomment -%}
                      {%- assign card_size_option_value = variant.options[size_option_index] -%} 

                      {%- for value in option.values -%}
                        
                        {%- assign is_selected = false -%}
                        {%- if value == variant.options[swatch_option_index] -%}
                          {%- assign is_selected = true -%}
                        {%- endif -%}

                        {%- assign is_swatch_available = false -%}
                        
                        {%- comment -%} Loop through all product variants to see if a combination of the current swatch value (Scent) and the current card's size is available (and subscribable) -{% endcomment -%}
                        {%- for product_variant in product.variants -%}

                          {%- assign variant_scent = product_variant.options[scent_option_index] -%}
                          {%- assign variant_size = product_variant.options[size_option_index] -%}

                          {%- comment -%} Check: Scent matches swatch value AND Size matches card's size AND variant is available AND is subscribable -{% endcomment -%}
                          {%- if variant_scent == value and variant_size == card_size_option_value and product_variant.available -%}
                            {%- if product_variant.selling_plan_allocations.size > 0 -%}
                              {%- assign is_swatch_available = true -%}
                              {%- break -%}
                            {%- endif -%}
                          {%- endif -%}
                        {%- endfor -%}
                        
                        {% comment %} {%- assign is_swatch_disabled = is_swatch_available == false -%} {% endcomment %}

                        {%- assign is_swatch_disabled = false -%}
                      {%- unless is_swatch_available -%}
                        {%- assign is_swatch_disabled = true -%}
                      {%- endunless -%}

                        <div class="color-swatch{% if color_white_label == color_value_downcase %}color-swatch--white{% endif %}{% if option.values.size ==1 %} hidden{% endif %}{% if is_swatch_disabled %} hidden{% endif %}">
                          <input
                            class="color-swatch__radio"
                            type="radio"
                            name="option{{ option.position }}"
                            form="{{ product_form_id }}"
                            id="card_swatch_{{ variant.id }}_{{ forloop.index }}"
                            value="{{ value | escape }}"
                            {% if is_selected %}
                              checked="checked"
                            {% endif %}
                            {% if is_swatch_disabled %}
                              disabled="disabled" 
                            {% endif %}
                          >
                          <label
                            class="color-swatch__item {% if is_selected %}selected{% endif %}"
                            for="card_swatch_{{ variant.id }}_{{ forloop.index }}"
                            title="{{ value | escape }}"
                            style="{%- render 'color-swatch-style', color_swatch_config: color_swatch_config, value: value -%}" 
                          >
                          </label>
                        </div>
                      {%- endfor -%}
                    </div>

                  {%- endif -%}
                  
                  {%- comment -%} 2. Subscription Dropdown (Selling Plan Selector) {%- endcomment -%}
                  {%- if product.selling_plan_groups.size > 0 -%}
                    <div class="rc-selling-plans-dropdown__wrapper">
                      <select class="rc-selling-plans-dropdown__select" name="selling_plan" form="{{ product_form_id }}">
                        {% for group in product.selling_plan_groups %}
                          {% comment %} Iterate through all plans in the group to populate the dropdown {%- endcomment -%}
                          {% for plan in group.selling_plans %}
                            <option value="{{ plan.id }}">
                              {{ plan.name }}
                            </option>
                          {% endfor %}
                        {% endfor %}
                      </select>
                    </div>
                  {% endif -%}
                  
                  {%- comment -%} 3. The SUBSCRIBE Button {%- endcomment -%}
                  <button
                    type="submit"
                    class="product-item__cta button button--primary button-80">
                    {% comment %} Subscribe {% endcomment %}
                     {% if product.selling_plan_groups.size > 0 %}
                      Subscribe
                     {% else %}
                        Add to cart
                     {%  endif %}
                    {% comment %} {{ 'general.button.subscribe' | t | default: "SUBSCRIBE" }} {% endcomment %}
                  </button>
                  
                  {%- comment -%} 4. Subscription Benefits Link {%- endcomment -%}
                   
                 {%- assign benefit_id = current_variant.id -%}
                 {%- assign global_popup_id = 'global-subscription-benefits-popup-' | append:  parent_section_id -%}
                 {% comment %} {%- assign global_popup_id = 'global-subscription-benefits-popup-' -%} {% endcomment %}
                 {%- if subs_benefits_header and product.selling_plan_groups.size > 0 -%}
                       <div class="subscription-benefits">
                         <span 
                          class="subs-benefits-link" 
                          data-popup-id="{{ global_popup_id }}" 
                          onclick="openSimplePopup('{{ global_popup_id }}')" 
                        >
                          <img src="{{ 'info-circle.svg' | asset_url }}" width="16" height="16" alt="Info" />
                          <s>{{ subs_benefits_header }}</s> 
                        </span>
                      </div>  
                     
                    {%- endif %}
    
                {%- endform -%}
              </product-form>


            {%- endif -%}
          </div>
        {%- endif -%}
    
      </div>
    </product-card>
    {% endif %}

{% endfor %}

<script>
document.addEventListener('DOMContentLoaded', () => {

  const productVariantCards = document.querySelectorAll('product-card[handle="{{ product.handle | escape }}"]:not(.hidden)');
  if (!productVariantCards.length) return;

  const productData = {{ product | json }};
  const productDataWithOption = {
   options: {{ product.options_with_values | json }},
   variants: {{ product.variants | json }}
  };
  const secondOptionPosition = 2; 
{% comment %} Â  Â  const secondOptionValue = productDataWithOption.options[secondOptionPosition - 1]?.values[0]; {% endcomment %}
  const secondOptionValue = "Refill";
  const secondOptionValue2 = "Refill (Pack of 2)";

  const allSwatches = document.querySelectorAll('product-card[handle="{{ product.handle | escape }}"]:not(.hidden) .color-swatch__radio');


  allSwatches.forEach(swatch => {
    swatch.addEventListener('change', (event) => {
      if (!event.target.checked) return;

      const selectedValue = event.target.value; // e.g., 'Cucumber & Mint'
      const clickedCard = event.target.closest('product-card');
      if (!clickedCard) return;

      const cardLockedSize = clickedCard.getAttribute('data-size')
      const selectedOptionPosition = 1;
      let newVariant = null;
      let visibleCard = null; // ðŸ‘ˆ Initialize the crucial reference here!


      newVariant = productData.variants.find(variant => {
        const scentMatch = variant.options[selectedOptionPosition - 1] === selectedValue;
        const sizeMatch = variant.options[secondOptionPosition - 1] === cardLockedSize;
        return scentMatch && sizeMatch;
      });

      
        
      const matchingSwatchInput = clickedCard.querySelector(`input.color-swatch__radio[value="${selectedValue}"]`);
      const matchingSwatchLabel = matchingSwatchInput ? matchingSwatchInput.nextElementSibling : null;

        // First, deselect all swatches on this card
      clickedCard.querySelectorAll('.color-swatch__item').forEach(label => label.classList.remove('selected'));
      clickedCard.querySelectorAll('.color-swatch__radio').forEach(input => input.checked = false);
                    // Then, select the matching swatch on this card
      if (matchingSwatchInput && matchingSwatchLabel) {
        matchingSwatchInput.checked = true;
        matchingSwatchLabel.classList.add('selected');
      }

            // 4c. Update visual selection on all cards (clean up any previous state)
      clickedCard.querySelectorAll('.color-swatch__item').forEach(label => {
        label.classList.remove('selected');
      });
        
      event.target.nextElementSibling.classList.add('selected');

      if (newVariant ) {
        const form = clickedCard.querySelector('form');
        const variantIdInput = form ? form.querySelector('input[name="id"]') : null;
              
        if (variantIdInput) {
            // THIS FIXES THE ADD TO CART ISSUE!
          variantIdInput.value = newVariant.id;
        }
                
        const primaryImage = clickedCard.querySelector('.product-card__image--primary');

        if (primaryImage) {
          let anchor = primaryImage.closest("a");
          const originalUrl = anchor.href;
          const url = new URL(originalUrl);                
          url.searchParams.set('variant', newVariant.id);
          const newUrl = url.toString();
          anchor.href = newUrl;
          let newMedia = productData.media.find(media => media.id === newVariant.featured_media.id);
          if (newMedia && newMedia.preview_image && newMedia.preview_image.src) {
            const imageSrc = newMedia.preview_image.src;
            primaryImage.src = imageSrc; 
            primaryImage.srcset = imageSrc; 
          }
        }
                
                // (Optional) Update Title using the visibleCard reference
        const productTitleElement = clickedCard.querySelector('.product-title'); 
        if(productTitleElement) {
          const originalUrl = productTitleElement.href;
          const url = new URL(originalUrl);                
          url.searchParams.set('variant', newVariant.id);
          const newUrl = url.toString();
          productTitleElement.href = newUrl;
          let title =  productData.title.split('(')[0].trim();
          productTitleElement.innerHTML = `<b>${title}</b> <br> ${newVariant.option1} <br> ${newVariant.option2}`;
        }
      }
    });
  });
});

</script>
